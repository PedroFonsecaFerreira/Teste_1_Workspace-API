<!DOCTYPE html>
<html>

<head>

  <title>BUILT CoLab - 3D Viewer Platform</title>
  
  <script src="jquery-3.5.1.min.js"></script>
  <script src="jquery-ui-1.12.1/jquery-ui.js"></script>
  <script src="https://cdn.rawgit.com/caldwell/renderjson/master/renderjson.js"></script>
  <script src="https://kit.fontawesome.com/2cc247d270.js" crossorigin="anonymous"></script>
  <link rel="icon" href="https://builtcolab.pt/wp-content/uploads/2020/10/builtcolab-icon-150x150.png" sizes="32x32" />
  <link rel="stylesheet" href="style.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@100;300;400;500&display=swap" rel="stylesheet"
    type='text/css'>
  


</head>

<body>
  <img src="images/builtcolab.jpg" alt="builtcolab">

  <div id="bar">
    <h1>IFC 3D VIEWER</h1>

  </div>

  <div id="container">

    <iframe id="viewerFrame" src="https://3d.connect.trimble.com/" 
    sandbox="allow-scripts allow-modals allow-forms allow-same-origin allow-popups"
    width="71%" height="700px" title="3D Viewer Application">
    </iframe>

    <div class="header1">
      IFC Class Selection

    </div>

    <div id="ifclist">

      <input type="hidden" class="form-control" id="classFilter"
      value=" " onkeypress="getObjectsByClass(event)">

      <ul class="ifcmenu">

        <li><a href="#">IFCBeam</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCBEAM')">Get</button>
          <select type="hidden" multiple="" class="form-control" id="selectionList_IFCBEAM" onchange="highlightSelected(this)" wfd-id="15">
            <option type="hidden" value="lVBbGbxptgE | 7010">lVBbGbxptgE | 7010</option>
          </select>
          <button class="highlightButtons" onclick="ChangeHighlightSelected('IFCBEAM')" title="Highlight IFCBEAM Elements"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCBuildingElementProxy</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCBUILDINGELEMENTPROXY')">Get</button> 
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCCovering</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCCOVERING')">Get</button>
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCFlowController</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCFLOWCONTROLLER')">Get</button>
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCColumn</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCCOLUMN')">Get</button>
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCDoor</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCDOOR')">Get</button> 
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCSlab</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCSLAB')">Get</button>
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>


        <li><a href="#">IFCFlowTerminal</a>
          <button class="getButtons" onclick="ChangeClassSelected('IFCFLOWTERMINAL')">Get</button>
          <button class="highlightButtons" title="Focus Frame" href="#viewerFrame"><i class="fas fa-lightbulb"></i></button>
        </li>

      </ul>

    </div>
    
  </div>

  
  <div class="header1" style="clear:both; margin-right: 0px;">
    Info Panel

  </div>
  <div class="row m-1" wfd-id="333" style ="clear: both; padding: 30px; margin-bottom: 60px; background-color: #eeeeee;">
    <div id="objectsLoading" class="d-flex justify-content-center" wfd-id="335" style="display: none;">
      <div class="spinner-border" role="status" style="display: none;" wfd-id="408">
        <span class="sr-only">Loading...</span>
      </div>
    </div>
    <div id="objectsResult" wfd-id="334"><pre class="renderjson"><span wfd-id="381"><span class="array" wfd-id="407" style="display: none;"><a class="disclosure" href="#">⊕</a><span class="array syntax">[</span><a href="#">1 item</a><span class="array syntax">]</span></span><span class="array" wfd-id="382" style="display: none;"><a class="disclosure" href="#">⊖</a><span class="array syntax" wfd-id="406">[</span><span wfd-id="405">
  </span><span wfd-id="385">   <span class="object" wfd-id="404" style="display: none;"><a class="disclosure" href="#">⊕</a><span class="object syntax">{</span><a href="#">2 items</a><span class="object syntax">}</span></span><span class="object" wfd-id="386" style="display: none;"><a class="disclosure" href="#">⊖</a><span class="object syntax" wfd-id="403">{</span><span wfd-id="402">
  </span><span wfd-id="401">        </span><span class="key" wfd-id="400">"modelId"</span><span class="object syntax" wfd-id="399">: </span><span wfd-id="398"></span><span class="string" wfd-id="397">"lVBbGbxptgE"</span><span class="syntax" wfd-id="396">,</span>
  <span wfd-id="395">        </span><span class="key" wfd-id="394">"objects"</span><span class="object syntax" wfd-id="393">: </span><span wfd-id="389"><span class="array" wfd-id="390"><a class="disclosure" href="#">⊕</a><span class="array syntax" wfd-id="392">[</span><a href="#">34 items</a><span class="array syntax" wfd-id="391">]</span></span></span>
  <span wfd-id="388">    </span><span class="object syntax" wfd-id="387">}</span></span></span>
  <span wfd-id="384"></span><span class="array syntax" wfd-id="383">]</span></span></span></pre></div>
  </div>



  <div id=footer_trim>
    <b>Morada:</b>&nbsp; Rua de Álvares Cabral 306 4050-040 Porto &emsp;&emsp; <b>E-mail:</b>&nbsp; geral@builtcolab.pt
  </div>
  
  <div id=footer>

    <img src="https://builtcolab.pt/wp-content/uploads/2020/08/Layer-2-1.svg" alt="entidades_rodape">
    <p id=copyright> &copy; 2020 <b>BUILT CoLAB</b> – Digital Built Environment – Todos os direitos reservados </p>

  </div>

  <button onclick="LockScrolling()" id="lockButton" title="Lock Scroll"><i class="fas fa-lock"></i></button>
  <button class="iframeButton" title="Focus Frame" href="#viewerFrame"><i class="far fa-window-maximize"></i></button>
  
  
  
  


  <script src="https://3d.connect.trimble.com/trimbleconnect.workspace.api.js"></script>
  <script>

    const viewer = document.getElementById("viewerFrame");
    var API = null;

    viewer.onload = async function () {
        console.log("Start Listener...");
        API = await Workspace.connect(viewer, (event, args) => {
            console.log("Passou pelo Workspace.connect");
            var eventName = event.split(".").pop();
            
            switch (eventName) {
                case "onSelectionChanged":
                    SelectionChanged(args.data);
                    break;

                case "onCameraChanged":
                    OnCameraChanged(args.data);
                    break;
            }
        });
        console.log("Listener Started!");
        onUserChanged(await API.user.getUser());
    }

    // Change Color Button
    function ChangeColorAll() {
        console.log("API: ", API);
        const state = { color: {} };
        Object.assign(state.color, { r: 155, g: 155, b: 15 });
        API.viewer.setObjectState({ selected: false }, state);
        //document.body.style.backgroundColor = "red";
    }

    // Reset color
    function ResetColors() {
        API.viewer.setObjectState(null, { color: "reset" });
    }

    $('.ifcmenu').on('click','li', function(){
      
      $(this).addClass('active').siblings().removeClass('active');

    });

    function ChangeClassSelected(nome){

      document.getElementById("classFilter").value = nome;
      return getObjectsByClass();
    }
    

    function getClassSelector() {
      return {
        parameter: {
          class: $("#classFilter").val()
          
        }
      };
    }
   
    async function getObjectsByClass(e) {
      return getObjectsBy(async () => API.viewer.getObjects(getClassSelector()), e);
    }

    async function getObjectsBy(action, e) {
      if (e && e.keyCode != 13) return;
      return doObjectsFilter(async () => {
        let result = await action();
        result = result && result.length
          ? renderjson.set_show_to_level(2)(result)
          : warn("Could not find any object. Make sure that the models are loaded and double-check the query!");
        return result;
      });
    }


    async function doObjectsFilter(action) {
      return doWorkRes("#objectsResult", "#objectsLoading", action);
    }

    async function doWorkRes(selResult, selLoading, action) {
      return doWorkSafe(() => {
        $(selResult).html("");
        $(selLoading).show();
      }, action, r => {
        $(selLoading).hide();
        $(selResult).html(r);
      });
    }

    async function doWorkSafe(preAction, action, postAction) {
      preAction();
      let result;
      try {
        const actionRes = await action();
        if (actionRes === false) {
          throw new Error("Operation failed: Unknown error");
        } else if (actionRes === true || actionRes === "" || actionRes == null) {
          result = ok();
        } else {
          result = actionRes;
        }
      }
      catch (e) {
        result = err(e);
      }
      postAction(result)
    }


  // When the user clicks on the button, scroll to the top of the document
  function LockScrolling() {
    
    if ($('body').hasClass('stop-scrolling')) {
      $('body').removeClass('stop-scrolling')
    } else {
      $('body').addClass('stop-scrolling')
    }
  }

  $(".iframeButton").ready(function() {
    $(".iframeButton").on("click", function( e ) {

      e.preventDefault();

      $("body, html").animate({ 
        scrollTop: $( $(this).attr('href') ).offset().top
      }, 600);

    });
  });

  function ChangeHighlightSelected(nome){

    document.getElementById("classFilter").value = nome;
    return highlightSelected();
  }

  async function highlightSelected() {
      const v = '<option value="lVBbGbxptgE | 2946">lVBbGbxptgE | 2946</option>;'.val();
      console.log(v);
      const selected = v.filter(s => !!s);
      for (const s of selected) {
        const [modelId, objectRuntimeId] = s.split(" | ");
        await API.viewer.setObjectState({
          modelObjectIds: [{ modelId, objectRuntimeIds: [parseInt(objectRuntimeId, 10)] }]
        }, {
          color: "#000000"
        });
      }
    }

  var o = JSON.parse(jsonstring);

  alert(o.features.length);

  for (const s of selection) {
    ++mCount;
    html += s.objectRuntimeIds.map(id => `<option value='${s.modelId} | ${id}'>${s.modelId} | ${id}</option>`).join();
    oCount += s.objectRuntimeIds.length;
  }

  
</script>
  
      
  
</body>
</html>



